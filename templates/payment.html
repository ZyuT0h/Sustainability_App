{% extends "/base/base_user.html" %}
{% block title %}Payment{% endblock %}

{% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#address').change(function() {
        if ($(this).is(':checked')) {
            // Use default/fake address
            $('#U_SA').val('543 Main St');
            $('#U_P').val('122543');
            $('#U_UN').val('10-23');
        } else {
            // Clear the address fields
            $('#U_SA').val('');
            $('#U_P').val('');
            $('#U_UN').val('');
        }
    });
});

$(document).ready(function() {
    $('#paymentForm').submit(function(event) {
        event.preventDefault(); // Prevent the default form submission

        // Submit the form via AJAX
        $.ajax({
            type: 'POST',
            url: '/payment',
            data: $('#paymentForm').serialize(),
            success: function(response) {
                // Show success message
                alert("Payment successful!");

                // Display cart items and total price
                var cartItems = response.cart_items;
                var totalPrice = response.total_price;

                // Display cart items
                var cartItemDetails = "Cart Items:\n";
                for (var product_id in cartItems) {
                    if (cartItems.hasOwnProperty(product_id)) {
                        var item = cartItems[product_id];
                        cartItemDetails += item.name + " - Quantity: " + item.quantity + " - Price: $" + item.price + "\n";
                    }
                }

                // Display total price
                cartItemDetails += "\nTotal Price: $" + totalPrice;

                // Display cart items and total price in alert
                alert(cartItemDetails);
            },
            error: function(xhr, status, error) {
                // Show error message
                alert("Payment failed. Please try again later.");
            }
        });
    });
});
</script>
<style>

        .row {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .column {
            width: 45%; /* Adjust width as needed */
            margin: 12px;
            padding: 20px;
            background-color: #f8f9fa; /* Light background color */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Box shadow for cards */
            border-radius: 8px;
            box-sizing: border-box;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
        }

        input[type="text"], button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
            width: 100%;
        }

        button {
            background-color:  #28a745;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: red;
        }

        h1, h3 {
            text-align: center;
        }

        .grouping {
            display: flex;
            justify-content: space-between;
        }

        .grouping input[type="text"] {
            width: 48%; /* Adjust width as needed */
        }
</style>
<br>
    <a href="/cart" class="back-button">Back to Cart</a>
    <div class="row">
        <div class="column">
            <div class="form-container">
                <div id="error-message" class="alert alert-danger" style="display: none;"></div> <!-- Error message container -->
                <form method="POST" id="paymentForm">
                    <h3>Address details</h3>
                        <div class="form-group">
                            <label for="U_SA">Shipping Address:</label>
                            <input type="text" id="U_SA" name="U_SA" placeholder="Blk 123 hillview street..">
                        </div>
                        <div class="grouping">
                            <div class="form-group">
                                <label for="U_P">Postal:</label>
                                <input type="text" id="U_P" name="U_P" placeholder="123456">
                            </div>
                            <div class="form-group">
                                <label for="U_UN">Unit No:</label>
                                <input type="text" id="U_UN" name="U_UN" placeholder="05-431">
                            </div>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="address"><label for="address">use default address</label>
                    </div>
                    <hr>
                    <h3>Card details</h3>
                    <div class="form-group">
                        <label for="U_CN">Card Name:</label>
                        <input type="text" id="U_CN" name="U_CN" placeholder="Zac Toh">
                    </div>
                    <div class="form-group">
                        <label for="U_CNO">Card Number:</label>
                        <input type="text" id="U_CNO" name="U_CNO" placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="grouping">
                        <div class="form-group">
                            <label for="U_ED">Expiry Date:</label>
                            <input type="text" id="U_ED" name="U_ED" placeholder="04/32">
                        </div>
                        <div class="form-group">
                            <label for="U_CVC/CVV">CVC/CVV:</label>
                            <input type="text" id="U_CVC/CVV" name="U_CVC" placeholder="123">
                        </div>
                    </div>
                    <button type="submit">Submit Payment</button>
                </form>
            </div>
        </div>
        <div class="column">
            <h2>Order summary</h2>
            <hr>
            <ul>
              {% for product_id, item in cart_items.items() %}
                <li>{{ item.name }} - Quantity: {{ item.quantity }} - Price: ${{ '%.2f'|format(item.price | float) }}</li>
              {% endfor %}
            </ul>
            <p>Total Price: ${{ '%.2f'|format(total_price) }}</p>
        </div>
    </div>
    <div id="popupMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 20px; border: 1px solid black; border-radius: 5px; z-index: 999;">
    <!-- Message content will be inserted here -->
    </div>

<script>
document.getElementById("paymentForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent the default form submission

    // Client-side validation
    var errorMessage = "";

    // Validation for all fields
    var shippingAddress = document.getElementById("U_SA").value;
    if (!shippingAddress) {
        errorMessage += "Shipping Address is required.<br>";
    }

    var postalCode = document.getElementById("U_P").value;
    if (!postalCode) {
        errorMessage += "Postal Code is required.<br>";
    } else if (!/^\d+$/.test(postalCode)) {
        errorMessage += "Postal Code must contain only numbers.<br>";
    } else if (postalCode.length !== 6) {
        errorMessage += "Postal Code must be 6 digits long.<br>";
    }

    // Validate unit number
    var unitNumber = document.getElementById("U_UN").value;
    if (!unitNumber) {
        errorMessage += "Unit Number is required.<br>";
    }

    // Validate card name
    var cardName = document.getElementById("U_CN").value;
    if (!cardName) {
        errorMessage += "Card Name is required.<br>";
    }

    var cardNumber = document.getElementById("U_CNO").value;
    if (!cardNumber) {
        errorMessage += "Card Number is required.<br>";
    }

    // Validate expiry date
    var expiryDate = document.getElementById("U_ED").value;
    if (!expiryDate) {
        errorMessage += "Expiry Date is required.<br>";
    }

    // Validate CVC/CVV
    var cvc = document.getElementById("U_CVC/CVV").value;
    if (!cvc) {
        errorMessage += "CVC/CVV is required.<br>";
    } else if (cvc.length !== 3) {
        errorMessage += "CVC/CVV must be 3 digits long.<br>";
    }

    // Display error message if validation fails
    if (errorMessage) {
        document.getElementById("error-message").innerHTML = errorMessage;
        document.getElementById("error-message").style.display = "block";
        return; // Exit function if there are errors
    }
    this.submit();
});
</script>
{% endblock %}
