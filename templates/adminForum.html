{% extends 'base/base_admin.html' %}
{% block title %}Inventory Management{% endblock %}

{% block content %}
<style>
    .reply {
    /* Add styling for each reply */
    margin-bottom: 10px;
    }
    .replies-container {
    /* Add styling for the container of replies */
    margin-top: 10px;
    }

    .comment-container {
    position: relative;
    }

    .delete-comment {
    position: absolute;
    top: 0;
    right: 0;
    margin: 5px;
    padding: 5px 10px;
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    }

</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.delete-comment');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentIndex = this.getAttribute('data-index');
                deleteComment(commentIndex);
            });
        });

        function deleteComment(commentIndex) {
            // Use AJAX to send a request to the server to delete the comment
            fetch('/delete_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ comment_index: commentIndex }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the comments section with the updated comments
                    const deletedComment = document.querySelector(`[data-index="${commentIndex}"]`);

                    // Update the content to indicate deletion
                    if (deletedComment) {
                        deletedComment.innerHTML = '<em>This comment has been deleted.</em>';
                    }
                } else {
                    console.error('Failed to delete comment');
                }
            })
            .catch(error => {
                console.error('Error during comment deletion:', error);
            });
        }
    });

    function submitReply(parentCommentIndex) {
    var replyMessage = document.getElementById("reply" + parentCommentIndex).value;

    fetch('/submit_reply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            parent_comment_index: parentCommentIndex,
            reply_message: replyMessage
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update comments list
            document.getElementById('commentsList').innerHTML = ""; // Clear existing comments
            data.comments.forEach(function(comment, index) {
                var commentDiv = document.createElement("div");
                commentDiv.innerHTML = comment.username + ":<br>" +
                                       comment.subject + "<br>" +
                                       comment.message + "<br>";
                if (comment.replies) {
                    comment.replies.forEach(function(reply) {
                        commentDiv.innerHTML += "&nbsp;&nbsp;Reply: " + reply + "<br>";
                    });
                }
                var replyForm = document.createElement("form");
                replyForm.onsubmit = function(event) {
                    event.preventDefault();
                    submitReply(index);
                };
                replyForm.innerHTML = "<input type='text' id='reply" + index + "' placeholder='Reply...'>" +
                                      "<button type='submit'>Submit Reply</button>";
                commentDiv.appendChild(replyForm);
                commentDiv.innerHTML += "<hr>";
                document.getElementById('commentsList').appendChild(commentDiv);
            });
        }
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}
</script>
<fieldset>
    <br>
    <h1>Forum</h1>
    {% if admin %}
        <hr>
        {% for comment in comments %}
            <div class="comment-container">
                <button class="delete-comment" data-index="{{ loop.index - 1 }}">Delete</button>
                {{ comment.username }}:<br>
                {{ comment.subject }}<br>
                {{ comment.message }}<br>
                {% if comment.replies %}
                    {% for reply in comment.replies %}
                        &nbsp;&nbsp;Reply: {{ reply }}<br>
                    {% endfor %}
                {% endif %}
                <form onsubmit="event.preventDefault(); submitReply({{ loop.index - 1 }});">
                    <input type="text" id="reply{{ loop.index - 1 }}" placeholder="Reply...">
                    <button type="submit">Reply</button>
                </form>
            </div>
            <hr>
        {% endfor %}
    {% endif %}
</fieldset>

{% endblock %}